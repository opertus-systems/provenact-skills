name: Issue Form Label Sync

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: read
  issues: write

jobs:
  sync-form-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Apply area/type/risk labels from issue form
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            function sectionValue(label) {
              const escaped = label.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              const re = new RegExp(`### ${escaped}\\n+([^\\n]+)`, "i");
              const m = body.match(re);
              return m ? m[1].trim().toLowerCase() : null;
            }

            const area = sectionValue("Area");
            const type = sectionValue("Type");
            const risk = sectionValue("Risk");

            const allowedAreas = new Set(["control", "control-web", "cli", "sdk", "agent-kit", "skills", "infra", "docs"]);
            const allowedTypes = new Set(["feature", "bug", "chore", "security", "docs", "research"]);
            const allowedRisks = new Set(["low", "med", "high"]);

            const desired = [];
            if (area && allowedAreas.has(area)) desired.push(`area:${area}`);
            if (type && allowedTypes.has(type)) desired.push(`type:${type}`);
            if (risk && allowedRisks.has(risk)) desired.push(`risk:${risk}`);

            if (!desired.length) {
              core.info("No parsable area/type/risk selections found; skipping.");
              return;
            }

            const existing = issue.labels.map(l => l.name);
            const toRemove = existing.filter(n =>
              (n.startsWith("area:") || n.startsWith("type:") || n.startsWith("risk:")) && !desired.includes(n)
            );

            for (const label of toRemove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: issue.number, name: label });
              } catch (e) {
                core.warning(`Could not remove label ${label}: ${e.message}`);
              }
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number: issue.number, labels: desired });
            core.info(`Applied labels: ${desired.join(", ")}`);
